---
title: "TFG: La Inteligencia Artificial aplicada a la Inteligencia Emocional"
author: "Jorge de Andrés"
date: "8 de Junio de 2019"
output:
  html_document:
    df_print: paged
  pdf_document: default
  word_document: 
    fig_height: 6
    fig_width: 8
always_allow_html: yes
---

```{r setup, include=FALSE}

#install.packages('knitr', dependencies = TRUE)

knitr::opts_chunk$set(echo = TRUE)

```

Borramos el environment lo primero para siempre tenerlo limpio en la ejecución:

```{r clean_environment}

rm(list=ls())

```

Importamos todas las librerías que vamos a ir necesitando:

```{r librerías, echo=TRUE, results='hide'}

#install.packages("ggplot2")
#install.packages("caret")
#install.packages("plyr")
#install.packages("wordcloud")
#install.packages("hexbin")
#install.packages("RColorBrewer")
#install.packages("corrplot")
#install.packages("FactoMineR")
#devtools::install_github("kassambara/factoextra")
#install.packages("factoextra")
#install.packages("nnet")
#install.packages("plotly")
#install.packages("class")
#install.packages("gmodels")
#install.packages("randomForest")
#install.packages("e1071")
#install.packages("ape")
#install.packages("cluster")
#install.packages("fpc")
#install.packages("devtools")
#devtools::install_github("vqv/ggbiplot")
#install.packages("party")
#install.packages("pROC")

library("ggplot2")
library("caret")
library("plyr")
library("wordcloud")
library("hexbin")
library("RColorBrewer")
library("corrplot")
library("FactoMineR")
library("factoextra")
library("nnet")
library("plotly")
library("class")
library("gmodels")
library("randomForest")
library("e1071")
library("ape")
library("cluster")
library("fpc")
library("devtools")
library("ggbiplot")
library("party")
library("pROC")

```


Lo primero que tengo que hacer es importar el dataset que he creado:

```{r importar_dataset}

dataset <- read.csv("Datos/datos.txt", header = TRUE)

```


Ahora lo que hago es pasarlo a una matriz, quitando tanto el nombre (que no me interesa) como la etiqueta (que no la necesito por ahora):

```{r creacion_matrices}

matriz.pacientes.etiquetas <- dataset[, -1]
matriz.pacientes.datos <- matriz.pacientes.etiquetas[, -25]

```

# Análisis Exploratorio

Primero compruebo que todos los datos tienen un tipo correcto.

```{r comprobacion_tipo_datos}

sapply(matriz.pacientes.datos, class)

```

Veo la media de la edad de los pacientes y el rango en el que se mueve

```{r datos_edad}

mean(matriz.pacientes.datos[, 1])
range(matriz.pacientes.datos[, 1])

```

 Voy a ver estos datos gráficamente:
 
```{r grafico_estadistica_edad}

qplot(1, matriz.pacientes.datos[, 1], xlab = "Pacientes", ylab = "Edad", geom="boxplot")

```
 Pasamos el qplot a PDF:
 
```{r qplot_edad_PDF}

pdf("Imágenes Obtenidas/boxplotEdadPacientes.pdf")

qplot(1, matriz.pacientes.datos[, 1], xlab = "Pacientes", ylab = "Edad", geom="boxplot")

dev.off

```
 
 
 Finalmente, veo un resúmen de cada columna
 
```{r summary_toda_matriz}

summary(matriz.pacientes.datos)

```
 

Como se puede ver, los datos de los pacientes están muy distanciados, y además su media es muy alta.
Así, la media de la edad difiere enormemente del resto de valores de la matriz.
Debido a ello, debemos de hacer un preprocesado de los datos del problema.

# Preparación de los datos

Como he comentado antes, Lo que voy a hacer ahora es un centrado y escalado de los datos de la matriz. De esta manera, la red neuronal no tendrá ningún valor que destaque especialmente y con ello no dará de inicio más peso a unos valores que a otros, ya que no lo buscamos.

Ahora hacemos un centrado y escalado de los datos, ya que la edad no sigue el rango del resto de valores, y distorsionaría la predicción

```{r centrado_escalado}

preObjeto <- preProcess(matriz.pacientes.datos, method=c("center", "scale"))  # Quiero hacer un centrado y escalado
matriz.pacientes.datos.centscal <- predict(preObjeto, matriz.pacientes.datos) # Obtengo los valores en la matriz centscal

```


Después del preprocesado, aunque con los datos no preprocesados, voy a hacer la visualización de algunas relaciones entre variables, de tal manera que podamos ver gráficamente algunos aspectos interesantes:

## Visualización de Datos

Para empezar voy a sacar una nube de palabras para mostrar los nombres más comúnes en los datos facilitados:

```{r wordcloud_nombres_preparacion, echo=T, results="hide"}

# Lo primero que tengo que hacer es contar la frecuencia de los nombres

dataNombres <- ddply(dataset,.(nom),nrow)
dataNombres <- dataNombres[order(dataNombres$V1, decreasing = TRUE), ]

```
Una vez que tengo los nombres contados y ordenados, es el momento de crear la WordCloud

```{r wordcloud}

set.seed(9999) # Para el mantenimiento del mismo patrón

wordcloud(words = dataNombres$nom, freq = dataNombres$V1, min.freq = 1, random.order=FALSE, rot.per=0.5, colors=c("Orange","Purple","Pink", "Red", "Yellow", "Green", "Blue", "Black"))

```

Lo pasamos a PDF:

```{r wordcloud_nombresPacientes_PDF}

set.seed(9999)

pdf("Imágenes Obtenidas/wordcloudNombresPacientes.pdf")

wordcloud(words = dataNombres$nom, freq = dataNombres$V1, min.freq = 1, random.order=FALSE, rot.per=0.5, colors=c("Orange","Purple","Pink", "Red", "Yellow", "Green", "Blue", "Black"))

dev.off

```


Ahora voy a sacar un plot para ver la relación entre la edad y el sexo de las personas que están en consulta

```{r grafico_edad_sexo}

plot(matriz.pacientes.datos[,1], matriz.pacientes.datos[,2], xlab="Edad", ylab="Sexo (0 - mujer, 1 - hombre)", main="Edad & Sexo")

```

Lo pasamos a PDF:

```{r grafico_edad-sexo_PDF}

pdf("Imágenes Obtenidas/GráficoEdad-Sexo.pdf")

plot(matriz.pacientes.datos[,1], matriz.pacientes.datos[,2], xlab="Edad", ylab="Sexo (0 - mujer, 1 - hombre)", main="Edad & Sexo")

dev.off

```


Otro plot para ver la correlación entre ser agresivo y ser impulsivo

```{r grafico_agresivo_impulsivo}

rf <- colorRampPalette(rev(brewer.pal(4,'Spectral')))
df <- data.frame(matriz.pacientes.datos[, 23], matriz.pacientes.datos[, 24])
h <- hexbin(df)

plot(h, colramp=rf, xlab="Agresivo", ylab="Impulsivo", main="Agresivo Vs Impulsivo")

```

Lo pasamos a PDF:

```{r grafico_agresivo-impulsivo_PDF}

pdf("Imágenes Obtenidas/GraficoAgresivoVsImpulsivo.pdf")

plot(h, colramp=rf, xlab="Agresivo", ylab="Impulsivo", main="Agresivo Vs Impulsivo")

dev.off

```


Otro plot similar para ver la relación de ser inhibido e impulsivo

```{r grafico_inhibido_impulsivo}

df <- data.frame(matriz.pacientes.datos[, 21], matriz.pacientes.datos[, 24])
h <- hexbin(df)

plot(h, colramp=rf, xlab="Inhibido", ylab="Impulsivo", main="Inhibido Vs Impulsivo")

```

Lo guardo en PDF:

```{r grafico_inhibido_impulsivo_PDF}

pdf("Imágenes Obtenidas/GraficoInhibidoVsImpulsivo.pdf")

plot(h, colramp=rf, xlab="Inhibido", ylab="Impulsivo", main="Inhibido Vs Impulsivo")

dev.off

```


Voy a ver la relación entre el razonamiento emocional (actuar según tus sentimientos) y la impulsividad

```{r grafico_razEm_Impulsivo}

df <- data.frame(matriz.pacientes.datos[, 20], matriz.pacientes.datos[, 24])
h <- hexbin(df)

plot(h, colramp=rf, xlab="Razonamiento Emocional", ylab="Impulsivo", main="Razonamiento Emocional Vs Impulsivo")

```

Lo guardo en PDF:

```{r grafico_razEM-Impulsivo_PDF}

pdf("Imágenes Obtenidas/GraficoRazonamientoEmocionalVsImpulsivo.pdf")

plot(h, colramp=rf, xlab="Razonamiento Emocional", ylab="Impulsivo", main="Razonamiento Emocional Vs Impulsivo")

dev.off

```

Ahora quiero sacar una relación entre ser agresivo y ver el grupo en el que están

```{r grafico_agresivo_grupo}

rf <- colorRampPalette(rev(brewer.pal(4,'Spectral')))
df <- data.frame(matriz.pacientes.datos[, 23], matriz.pacientes.etiquetas[, 25])
h <- hexbin(df)

plot(h, colramp=rf, xlab="Agresivo", ylab="Grupo", main="Agresivo Y Grupo Real")


```

Lo guardo en PDF:

```{r grafico_agresivo-grupo_PDF}

pdf("Imágenes Obtenidas/GraficoAgresivoVsGrupo.pdf")

plot(h, colramp=rf, xlab="Agresivo", ylab="Grupo", main="Agresivo Y Grupo Real")

dev.off

```


Voy a hacer lo mismo con la impulsividad

```{r grafico_impulsivo_grupo}

rf <- colorRampPalette(rev(brewer.pal(4,'Spectral')))
df <- data.frame(matriz.pacientes.datos[, 24], matriz.pacientes.etiquetas[, 25])
h <- hexbin(df)

plot(h, colramp=rf, xlab="Impulsivo", ylab="Grupo", main="Impulsivo y Grupo Real")

```

Lo guardo en PDF:

```{r grafico_impulsivo-grupo_PDF}

pdf("Imágenes Obtenidas/GraficoImpulsivoVsGrupo.pdf")

plot(h, colramp=rf, xlab="Impulsivo", ylab="Grupo", main="Impulsivo y Grupo Real")

dev.off

```


De estas gráficas estamos obteniendo información realmente interesante antes de la predicción de los datos.
He preferido hacer gráficas en 2D porque las gráficas en 3D son mucho más difíciles de interpretar que estas bonitas gráficas en 2D

Vamos a ver la correlación que tienen mis variables 

```{r calculo_correlacion}

res <- cor(matriz.pacientes.datos[, 1:24], method = "spearman") # Por mi tipo de datos, hacemos la correlación por spearman
options(width = 100)
res.round <- round(res, 2)

```

Como saca una tabla enorme, lo que voy a hacer es usar una librería que me da una función para sacar de una forma bonita las correlaciones entre las variables.

```{r grafico_correlaciones_variables}

corrplot(res.round, method="circle")

```

Guardamos la matriz de correlación en PDF para tener mejor visualización:

```{r matriz_correlacion_PDF}

pdf("Imágenes Obtenidas/Corrplot.pdf")

corrplot(res.round, method="circle")

dev.off

```


Como podemos ver, por ejemplo, resiliencia baja y media tienen una correlación de -1, ya que si hay una no hay la otra y viceversa.
Esto pasa igual con las relaciones entre contexto, ya que buena - trauma, trauma - mala, mala - buena tienen que ser inversas.

Ahora voy a sacar un PCA para ver la importancia de las variables:

Para los cálculos, uso la matriz con el centrado y escalado ya hechos

```{r PCA_Calculations}

resultado.pca <- PCA(matriz.pacientes.datos.centscal, graph = FALSE)

#Con la siguiente línea podemos ver que podemos hacer con esto calculado
print(resultado.pca)

```
Nos interesa ver los eigenvalues, que son los que presentarán la cantidad de varianza que aportan las variables:

```{r table_eigenvalues_PCA}

eigenvalues.PCA <- resultado.pca$eig
eigenvalues.PCA

```
Como se puede comprobar, de las 24 variables (componentes) que tenemos, la mitad de la varianza la conseguimos con aproximadamente 5 variables.
También se puede ver que a parti de las 17 variables prácticamente no hay un aumento de la varianza.
En el caso de un problema grande, sería interesante la eliminación de algunas de las variables, para dejar un dataset más pequeño con el que poder trabajar. En nuestro caso, nuestro problema es pequeño, y además las variables están escogidas a mano, por lo que no haré una reducción del dataset.

Ahora, para completar este apartado de PCA, lo que voy a hacer es sacar la gráfica de la varianza acumulada con los valores anteriores:

```{r PCA_eigenvalues_graph}

plotPCA <- fviz_screeplot(resultado.pca, ncp=24)
plot(plotPCA)

fviz_pca_biplot(resultado.pca, repel = TRUE,
                    col.var = "#FF0040", # Color de las variables (vectores)
                    col.ind = "#21610B", # Color de cada individuo (puntos)
                    label = "var",
                    title = "Plot Binario - Elementos / Dimensiones",
                    geom.ind = "point",
                    pointshape = 4)  

ggbiplot(resultado.pca, ellipse=TRUE, labels=rownames(dataset), groups=dataset$grupo)

```



Con esto puedo sacar conclusiones al igual que con el gran gráfico de correlaciones de variables, solo que esta representación está intencionada para más de 2 dimensiones.

Puedo ver algunas de las conclusiones fáciles que saqué anteriormente, como que resiliencia media es contraria a baja, o que la relación con el contexto de trauma y mala son contrarias a buena.

Otras relaciones también puedo ver, como que los deberías y el razonamiento emocional parecen ser ciertamente contrarios, o que el filtro mental no depende de prácticamente nada ya que está en todo el centro.

También es importante ver como, mediante dos componentes principales (dos dimensiones), solo estoy explicando un del 30,2% del total, lo que es muy poco. Por unirlo con los gráficos anteriores, estas dos componentes que se han elegido como x e y son las dos variables que más varianza (y por lo tanto, explicación) tenían en el gráfico de barras anterior.


Obtengo estos gráficos en PDF para tener una mejor visualización:

```{r eigenvalues_graph_PDF}

pdf("Imágenes Obtenidas/GraficoEigenvalues.pdf")

plot(plotPCA)

fviz_pca_biplot(resultado.pca, repel = TRUE,
                    col.var = "#FF0040", # Color de las variables (vectores)
                    col.ind = "#21610B", # Color de cada individuo (puntos)
                    label = "var",
                    title = "Plot Binario - Elementos / Dimensiones",
                    geom.ind = "point",
                    pointshape = 4)  

ggbiplot(resultado.pca, ellipse=TRUE, labels=rownames(dataset), groups=dataset$grupo)

dev.off

```


Ahora voy a sacar un "Factor Map" de las variables. Esto lo puedo hacer gracias a las coordenadas que me da una de las variables tras hacer el PCA.
Así, voy primero a ver la tabla y luego voy a sacar el mapa:

```{r PCA_Coordinates}

resultado.pca$var$coord

```
Como se puede ver, me está poniendo mis 24 variables en 5 dimensiones, con unas coordenadas concretas. Ahora, lo que voy a hacer, es representarlo.
Con esta representación podré sacar algunas conclusiones:


Ahora mi siguiente paso es sacar un gráfico de los individuos, para ver donde están colocados en este sistema:

```{r coordenadas_individuos}

head(resultado.pca$ind$coord) # Solo saco los primeros para no ocupar demasiado espacio

```

Ahora, tras ver que todos mis individuos tienen unas ciertas coordenadas, vamos a representarlos gráficamente:

```{r plot_coordendas_individuos}

# Saco este gráfico para ver los individuos de una forma más clara

fviz_pca_ind(resultado.pca, repel = T)

```

Exporto a PDF las coordenadas de los individuos:

```{r coordenadas_individuos_PDF}

pdf("Imágenes Obtenidas/GraficoIndividuosPCA.pdf")

fviz_pca_ind(resultado.pca, repel = T)

dev.off

```



Se puede ver que la mayoría de los pacientes están en torno al centro, mientras que tenemos un outlayer, que es el número 27.

***

# Modelos de Inteligencia Artificial supervisados


Ahora lo que hago es coger un conjunto muy grande de los datos para hacer el entrenamiento

```{r creación_conjunto_entrenamiento}

conjuntoEntrenamiento <- sample(1:67, 55)

```


###############################################################
#################### 1 NEURONA ################################
###############################################################


Lo que voy a hacer ahora es entrenar la red neuronal con diferente cantidad de neuronas,y voy a ir comparando el resultado...

###################### SIN SOFTMAX #############################

```{r 1_neurona}

set.seed(1)

dataframe.resultados.1neu <- data.frame(Ent_1Neu = numeric(),
                                        Test_1Neu = numeric())

conf.1neu <- vector(mode = "list", length = 50)

for(i in 1:50)
{
  pacientes.1neu <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], 
                          class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ), 
                          size=1, 
                          trace = F)

  #Una vez que lo tengo entrenado, lo que voy a hacer es calcular el error tanto en el entrenamiento como en el test de cada uno
  
  pacientes.prediccion.1neu <- predict( pacientes.1neu, 
                                        matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], 
                                        type="raw" )
  head(pacientes.prediccion.1neu) # Vemos las probabilidades de pertenencia de cada valor
  
  # Ahora que los tengo todos entrenados, Determinamos cual es la máxima, es decir, la clase a la que hay que asignar los objetos
  
  pacientes.prediccion.1neu.class <- apply( pacientes.prediccion.1neu, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.1neu.class
  
  # Lo visualizo en forma de tabla para ir viendo el error
  
  table( pacientes.prediccion.1neu.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  #Calculo el acierto
  
  acierto.ent.teorico.1neu <- sum( diag( table( pacientes.prediccion.1neu.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  #TEST
  
  pacientes.prediccion.test.1neu <- predict( pacientes.1neu, 
                                             matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], 
                                             type="raw" )
  pacientes.prediccion.test.1neu
  
  pacientes.prediccion.test.1neu.class <- apply( pacientes.prediccion.test.1neu, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.1neu.class
  
  conf.1neu[[i]] <- table( pacientes.prediccion.test.1neu.class , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.test.teorico.1neu <- sum( diag( table( pacientes.prediccion.test.1neu.class, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  dataframe.pasada <- data.frame(Ent_1Neu = acierto.ent.teorico.1neu,
                                 Test_1Neu = acierto.test.teorico.1neu)
  
  dataframe.resultados.1neu <- rbind(dataframe.resultados.1neu, dataframe.pasada)
  
  

}

head(dataframe.resultados.1neu[order(dataframe.resultados.1neu$Test_1Neu, decreasing = T), ])

# Como vemos, el mejor resultado lo obtenemos en el entrenamiento #48
# Lo automatizamos y sacamos la matriz de confusión:

conf.1neu[[which.max(dataframe.resultados.1neu$Test_1Neu)]]

```


Lo voy a entrenar también con el SOFTMAX = true. Esto optimiza la verosimilitud, no el error cuadrático medio...

###################### CON SOFTMAX ##############################

```{r 1_neurona_SOFTMAX}

set.seed(1)

dataframe.resultados.1neu.soft <- data.frame(Ent_1Neu_soft = numeric(),
                                             Test_1Neu_soft = numeric())
conf.1neu.s <- vector(mode = "list", length = 50)

for(i in 1:50)
{
  pacientes.1neu.softmax <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                                  class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                                  size=1,
                                  softmax = T,
                                  trace = F)

  #Una vez que lo tengo entrenado, lo que voy a hacer es calcular el error tanto en el entrenamiento como en el test de cada uno
  
  pacientes.prediccion.1neu.softmax <- predict( pacientes.1neu.softmax, 
                                                matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], 
                                                type="raw" )
  head(pacientes.prediccion.1neu.softmax) # Vemos las probabilidades de pertenencia de cada valor
  
  # Ahora que los tengo todos entrenados, Determinamos cual es la máxima, es decir, la clase a la que hay que asignar los objetos
  
  pacientes.prediccion.1neu.class.softmax <- apply( pacientes.prediccion.1neu.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.1neu.class.softmax
  
  # Lo visualizo en forma de tabla para ir viendo el error
  
  table( pacientes.prediccion.1neu.class.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  #Calculo el acierto
  
  acierto.ent.teorico.1neu.soft <- sum( diag( table( pacientes.prediccion.1neu.class.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  #TEST
  
  pacientes.prediccion.test.1neu.softmax <- predict( pacientes.1neu.softmax,
                                                     matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], 
                                                     type="raw" )
  pacientes.prediccion.test.1neu.softmax
  
  pacientes.prediccion.test.1neu.class.softmax <- apply( pacientes.prediccion.test.1neu.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.1neu.class.softmax
  
  conf.1neu.s[[i]] <- table( pacientes.prediccion.test.1neu.class.softmax , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.test.teorico.1neu.soft <- sum(diag(table(pacientes.prediccion.test.1neu.class.softmax, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25])))/12
  
  dataframe.pasada <- data.frame(Ent_1Neu_soft = acierto.ent.teorico.1neu.soft,
                                 Test_1Neu_soft = acierto.test.teorico.1neu.soft)
  
  dataframe.resultados.1neu.soft <- rbind(dataframe.resultados.1neu.soft ,dataframe.pasada)
  
}

head(dataframe.resultados.1neu.soft[order(dataframe.resultados.1neu.soft$Test_1Neu_soft, decreasing = T), ])

# El mejor resultado ha sido en el entrenamiento #27

conf.1neu.s[[27]]

```



###############################################################
#################### 2 NEURONAS ###############################
###############################################################

A partir de ahora voy a hacer exactamente lo mismo, por lo que haré chunks más grandes para evitar una sobrecarga de chunks, y reduciré la cantidad de comentarios, ya que serán redundantes

###################### SIN SOFTMAX #############################

```{r 2_neuronas}

set.seed(1)

dataframe.resultados.2neu <- data.frame(Ent_2Neu = numeric(),
                                        Test_2Neu = numeric())
conf.2neu <- vector(mode = "list", length = 50)
  
for(i in 1:50)
{

  pacientes.2neu <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                          class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                          size=2,
                          trace = F )
  
  pacientes.prediccion.2neu <- predict( pacientes.2neu,
                                        matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                                        type="raw" )
  head(pacientes.prediccion.2neu) # Vemos las probabilidades de pertenencia de cada valor
  
  pacientes.prediccion.2neu.class <- apply( pacientes.prediccion.2neu, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.2neu.class
  
  
  table( pacientes.prediccion.2neu.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  acierto.teorico.entrenamiento.2neu <- sum( diag( table( pacientes.prediccion.2neu.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  # TEST
  
  pacientes.prediccion.test.2neu <- predict( pacientes.2neu,
                                             matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24],
                                             type="raw" )
  pacientes.prediccion.test.2neu
  
  pacientes.prediccion.test.2neu.class <- apply( pacientes.prediccion.test.2neu, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.2neu.class
  
  conf.2neu[[i]] <- table( pacientes.prediccion.test.2neu.class , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.teorico.test.2neu <- sum( diag( table( pacientes.prediccion.test.2neu.class, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_2Neu = acierto.teorico.entrenamiento.2neu,
                                 Test_2neu = acierto.teorico.test.2neu)
  
  dataframe.resultados.2neu <- rbind(dataframe.resultados.2neu, dataframe.pasada)
  
  
}

head(dataframe.resultados.2neu[order(dataframe.resultados.2neu$Test_2neu, decreasing = T), ])

# El mejor entrenamiento ha sido en la pasada #9, 18 y 38

conf.2neu[[9]]
conf.2neu[[18]]
conf.2neu[[38]]

```


###################### CON SOFTMAX ##############################

```{r 2_neuronas_SOFTMAX}

set.seed(1)

dataframe.resultados.2neu.soft <- data.frame(Ent_2Neu_soft = numeric(),
                                             Test_2Neu_soft = numeric())

conf.2neu.s <- vector(mode = "list", length = 50)

for(i in 1:50)
{

  pacientes.2neu.softmax <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                                  class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                                  size=2,
                                  softmax = T,
                                  trace = F )
  
  pacientes.prediccion.ent.2neu.softmax <- predict( pacientes.2neu.softmax, 
                                                    matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], 
                                                    type="raw" )
  head(pacientes.prediccion.ent.2neu.softmax)
  
  pacientes.prediccion.ent.2neu.class.softmax <- apply( pacientes.prediccion.ent.2neu.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.ent.2neu.class.softmax
  
  table( pacientes.prediccion.ent.2neu.class.softmax , matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )
  acierto.teorico.ent.2neu.softmax <- sum( diag( table( pacientes.prediccion.ent.2neu.class.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55
  
  # TEST
  
  pacientes.prediccion.test.2neu.softmax <- predict( pacientes.2neu.softmax, 
                                                     matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24],
                                                     type="raw" )
  pacientes.prediccion.test.2neu.softmax
  
  pacientes.prediccion.test.2neu.class.softmax <- apply( pacientes.prediccion.test.2neu.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.2neu.class.softmax
  
  conf.2neu.s[[i]] <- table( pacientes.prediccion.test.2neu.class.softmax , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.teorico.test.2neu.softmax <- sum(diag(table(pacientes.prediccion.test.2neu.class.softmax, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_2Neu_soft = acierto.teorico.ent.2neu.softmax,
                                 Test_2neu_soft = acierto.teorico.test.2neu.softmax)
  
  dataframe.resultados.2neu.soft <- rbind(dataframe.resultados.2neu.soft, dataframe.pasada)
}

head(dataframe.resultados.2neu.soft[order(dataframe.resultados.2neu.soft$Test_2neu_soft, decreasing = T), ])

# El mejor entrenamiento ha sido en la pasada 9, 10...

conf.2neu.s[[9]]
conf.2neu.s[[10]]

```



###############################################################
#################### 3 NEURONAS ###############################
###############################################################

###################### SIN SOFTMAX #############################

```{r 3_neuronas}

set.seed(1)

dataframe.resultados.3neu <- data.frame(Ent_3Neu = numeric(),
                                        Test_3Neu = numeric())

conf.3neu <- vector(mode = "list", length = 50)

for(i in 1:50)
{

  pacientes.3neu <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                          class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                          size=3,
                          trace = F)
  
  pacientes.prediccion.3neu <- predict( pacientes.3neu, matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], type="raw" )
  head(pacientes.prediccion.3neu) # Vemos las probabilidades de pertenencia de cada valor
  
  
  pacientes.prediccion.3neu.class <- apply( pacientes.prediccion.3neu, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.3neu.class
  
  
  table( pacientes.prediccion.3neu.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  
  acierto.teorico.entrenamiento.3neu <- sum( diag( table( pacientes.prediccion.3neu.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  # TEST
  
  pacientes.prediccion.test.3neu <- predict( pacientes.3neu, matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], type="raw" )
  pacientes.prediccion.test.3neu
  
  pacientes.prediccion.test.3neu.class <- apply( pacientes.prediccion.test.3neu, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.3neu.class
  
  conf.3neu[[i]] <- table( pacientes.prediccion.test.3neu.class , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.teorico.test.3neu <- sum( diag( table( pacientes.prediccion.test.3neu.class, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_3Neu = acierto.teorico.entrenamiento.3neu,
                                 Test_3neu = acierto.teorico.test.3neu)
  
  dataframe.resultados.3neu <- rbind(dataframe.resultados.3neu, dataframe.pasada)
}

head(dataframe.resultados.3neu[order(dataframe.resultados.3neu$Test_3neu, decreasing = T), ])

# El mejor entrenamiento ha sido en la pasada 44

conf.3neu[[44]]

```


###################### CON SOFTMAX ##############################

```{r 3_neuronas_SOFTMAX}

set.seed(1)

dataframe.resultados.3neu.soft <- data.frame(Ent_3Neu_soft = numeric(),
                                             Test_3Neu_soft = numeric())

conf.3neu.s <- vector(mode = "list", length = 50)

for(i in 1:50)
{

  pacientes.3neu.softmax <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                                  class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                                  size=3, 
                                  softmax = T, 
                                  trace = F)
  
  pacientes.prediccion.3neu.softmax <- predict( pacientes.3neu.softmax, matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], type="raw" )
  head(pacientes.prediccion.3neu.softmax) # Vemos las probabilidades de pertenencia de cada valor
  
  
  pacientes.prediccion.3neu.class.softmax <- apply(pacientes.prediccion.3neu.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.3neu.class.softmax
  
  
  table( pacientes.prediccion.3neu.class.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  
  acierto.teorico.ent.3neu.softmax <- sum( diag( table( pacientes.prediccion.3neu.class.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  #TEST
  
  pacientes.prediccion.test.3neu.softmax <- predict( pacientes.3neu.softmax, matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], type="raw" )
  pacientes.prediccion.test.3neu.softmax
  
  pacientes.prediccion.test.3neu.class.softmax <- apply( pacientes.prediccion.test.3neu.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.3neu.class.softmax
  
  conf.3neu.s[[i]] <- table( pacientes.prediccion.test.3neu.class.softmax , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.teorico.test.3neu.softmax <- sum( diag( table( pacientes.prediccion.test.3neu.class.softmax, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_3Neu_soft = acierto.teorico.ent.3neu.softmax,
                                 Test_3neu_soft = acierto.teorico.test.3neu.softmax)
  
  dataframe.resultados.3neu.soft <- rbind(dataframe.resultados.3neu.soft, dataframe.pasada)
}

head(dataframe.resultados.3neu.soft[order(dataframe.resultados.3neu.soft$Test_3neu_soft, decreasing = T), ])

# El mejor entrenamieno ha sido en la pasada 13, 38, 39, 48

conf.3neu.s[[13]]
conf.3neu.s[[38]]
conf.3neu.s[[39]]
conf.3neu.s[[48]]

```



###############################################################
#################### 3 NEURONAS ###############################
###################  Con Decay  ###############################
###############################################################

###################### SIN SOFTMAX #############################

```{r 3_neuronas_decay}

set.seed(1)

dataframe.resultados.3neu.decay <- data.frame(Ent_3Neu_decay = numeric(),
                                              Test_3Neu_decay = numeric())

conf.3neu.d <- vector(mode = "list", length = 50)

for(i in 1:50)
{

  pacientes.3neu.decay <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                                class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                                size=3,
                                decay = 0.2, 
                                trace = F)
  
  pacientes.prediccion.3neu.decay <- predict( pacientes.3neu.decay, matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], type="raw" )
  head(pacientes.prediccion.3neu.decay) # Vemos las probabilidades de pertenencia de cada valor
  
  
  pacientes.prediccion.3neu.class.decay <- apply( pacientes.prediccion.3neu.decay, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.3neu.class.decay
  
  
  table( pacientes.prediccion.3neu.class.decay, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  
  acierto.teorico.ent.3neu.decay <- sum( diag( table( pacientes.prediccion.3neu.class.decay, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  #TEST
  
  pacientes.prediccion.test.3neu.decay <- predict( pacientes.3neu.decay, matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], type="raw" )
  pacientes.prediccion.test.3neu.decay
  
  pacientes.prediccion.test.3neu.class.decay <- apply( pacientes.prediccion.test.3neu.decay, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.3neu.class.decay
  
  conf.3neu.d[[i]] <- table( pacientes.prediccion.test.3neu.class.decay , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.teorico.test.3neu.decay <- sum( diag( table( pacientes.prediccion.test.3neu.class.decay, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_3Neu_decay = acierto.teorico.ent.3neu.decay,
                                 Test_3neu_decay = acierto.teorico.test.3neu.decay)
  
  dataframe.resultados.3neu.decay <- rbind(dataframe.resultados.3neu.decay, dataframe.pasada)
  
}
  
head(dataframe.resultados.3neu.decay[order(dataframe.resultados.3neu.decay$Test_3neu_decay, decreasing = T), ])

# El mejor entenamiento ha sido en la pasada 7, 29, 36

conf.3neu.d[[7]]
conf.3neu.d[[29]]
conf.3neu.d[[36]]

```


###################### CON SOFTMAX ##############################

```{r 3_neuronas_decay_SOFTMAX}

set.seed(1)

dataframe.resultados.3neu.decay.softmax <- data.frame(Ent_3Neu_decay_sf = numeric(),
                                                      Test_3Neu_decay_sf = numeric())
conf.3neu.d.s <- vector(mode = "list", length = 50)

for(i in 1:50)
{

  pacientes.3neu.decay.softmax <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                                        class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                                        size=3, 
                                        softmax = T,
                                        decay = 0.03, 
                                        trace = F)
  
  pacientes.prediccion.3neu.decay.softmax <- predict( pacientes.3neu.decay.softmax, matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], type="raw" )
  head(pacientes.prediccion.3neu.decay.softmax) # Vemos las probabilidades de pertenencia de cada valor
  
  
  pacientes.prediccion.3neu.class.decay.softmax <- apply( pacientes.prediccion.3neu.decay.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.3neu.class.decay.softmax
  
  
  table( pacientes.prediccion.3neu.class.decay.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  
  acierto.teorico.ent.3neu.decay.sf <- sum( diag( table( pacientes.prediccion.3neu.class.decay.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  # TEST
  
  pacientes.prediccion.test.3neu.decay.softmax <- predict( pacientes.3neu.decay.softmax, matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], type="raw" )
  pacientes.prediccion.test.3neu.decay.softmax
  
  pacientes.prediccion.test.3neu.class.decay.softmax <- apply( pacientes.prediccion.test.3neu.decay.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.3neu.class.decay.softmax
  
  conf.3neu.d.s[[i]] <- table( pacientes.prediccion.test.3neu.class.decay.softmax , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  
  acierto.teorico.test.3neu.decay.sf <- sum( diag( table( pacientes.prediccion.test.3neu.class.decay.softmax, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_3Neu_decay_sf = acierto.teorico.ent.3neu.decay.sf,
                                 Test_3neu_decay_sf = acierto.teorico.test.3neu.decay.sf)
  
  dataframe.resultados.3neu.decay.softmax <- rbind(dataframe.resultados.3neu.decay.softmax, dataframe.pasada)
}
  
head(dataframe.resultados.3neu.decay.softmax[order(dataframe.resultados.3neu.decay.softmax$Test_3neu_decay_sf, decreasing = T), ])

# El mejor entrenamiento ha sido en la pasada 33

conf.3neu.d.s[[33]]

```


###############################################################
#################### 5 NEURONAS ###############################
###############################################################

###################### SIN SOFTMAX #############################

```{r 5_neuronas}

set.seed(1)

dataframe.resultados.5neu <- data.frame(Ent_5Neu = numeric(),
                                        Test_5Neu = numeric())

conf.5neu <- vector(mode = "list", length = 50)

for(i in 1:50)
{

  pacientes.5neu <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                          class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                          size=5,
                          trace = F )
  
  pacientes.prediccion.5neu <- predict( pacientes.5neu, matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], type="raw" )
  head(pacientes.prediccion.5neu) # Vemos las probabilidades de pertenencia de cada valor
  
  pacientes.prediccion.5neu.class <- apply( pacientes.prediccion.5neu, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.5neu.class
  
  table( pacientes.prediccion.5neu.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  acierto.teorico.entrenamiento.5neu <- sum( diag( table( pacientes.prediccion.5neu.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  #TEST
  
  pacientes.prediccion.test.5neu <- predict( pacientes.5neu, matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], type="raw" )
  pacientes.prediccion.test.5neu
  
  pacientes.prediccion.test.5neu.class <- apply( pacientes.prediccion.test.5neu, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.5neu.class
  
  conf.5neu[[i]] <- table( pacientes.prediccion.test.5neu.class , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.teorico.test.5neu <- sum( diag( table( pacientes.prediccion.test.5neu.class, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_5Neu = acierto.teorico.entrenamiento.5neu,
                                 Test_5neu = acierto.teorico.test.5neu)
  
  dataframe.resultados.5neu <- rbind(dataframe.resultados.5neu, dataframe.pasada)
  
}

head(dataframe.resultados.5neu[order(dataframe.resultados.5neu$Test_5neu, decreasing = T), ])

# El mejor entrenamiento ha sido en la pasada 4 y 35

conf.5neu[[4]]
conf.5neu[[35]]

```


###################### CON SOFTMAX ##############################

```{r 5_neuronas_SOFTMAX}

set.seed(1)

dataframe.resultados.5neu.soft <- data.frame(Ent_5Neu_soft = numeric(),
                                             Test_5Neu_soft = numeric())

conf.5neu.s <- vector(mode = "list", length = 50)

for(i in 1:50)
{

  pacientes.5neu.softmax <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                                  class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                                  size=5,
                                  softmax = T,
                                  trace = F )
  
  pacientes.prediccion.5neu.softmax <- predict( pacientes.5neu.softmax, matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], type="raw" )
  head(pacientes.prediccion.5neu.softmax) # Vemos las probabilidades de pertenencia de cada valor
  
  pacientes.prediccion.5neu.class.softmax <- apply( pacientes.prediccion.5neu.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.5neu.class.softmax
  
  table( pacientes.prediccion.5neu.class.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  acierto.teorico.ent.5neu.softmax <- sum( diag( table( pacientes.prediccion.5neu.class.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  # TEST
  
  pacientes.prediccion.test.5neu.softmax <- predict( pacientes.5neu.softmax, matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], type="raw" )
  pacientes.prediccion.test.5neu.softmax
  
  pacientes.prediccion.test.5neu.class.softmax <- apply( pacientes.prediccion.test.5neu.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.5neu.class.softmax
  
  conf.5neu.s[[i]] <-table( pacientes.prediccion.test.5neu.class.softmax, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.teorico.test.5neu.softmax <- sum( diag( table( pacientes.prediccion.test.5neu.class.softmax, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_5Neu_soft = acierto.teorico.ent.5neu.softmax,
                                 Test_5neu_soft = acierto.teorico.test.5neu.softmax)
  
  dataframe.resultados.5neu.soft <- rbind(dataframe.resultados.5neu.soft, dataframe.pasada)
}

head(dataframe.resultados.5neu.soft[order(dataframe.resultados.5neu.soft$Test_5neu_soft, decreasing = T), ])

# El mejor entrenamiento ha sido en la pasada 39

conf.5neu.s[[39]]

```



###############################################################
#################### 5 NEURONAS ###############################
#################### CON DECAY  ###############################
###############################################################

###################### SIN SOFTMAX #############################

```{r 5_neuronas_decay}

set.seed(1)

dataframe.resultados.5neu.decay <- data.frame(Ent_5Neu_decay = numeric(),
                                              Test_5Neu_decay = numeric())

conf.5neu.d <- vector(mode = "list", length = 50)

for(i in 1:50)
{

  pacientes.5neu.decay <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                                class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ),
                                size=5,
                                decay=0.1,
                                trace = F)
  
  pacientes.prediccion.5neu.decay <- predict( pacientes.5neu.decay, matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], type="raw" )
  head(pacientes.prediccion.5neu.decay) # Vemos las probabilidades de pertenencia de cada valor
  
  pacientes.prediccion.5neu.decay.class <- apply( pacientes.prediccion.5neu.decay, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.5neu.decay.class
  
  table( pacientes.prediccion.5neu.decay.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  acierto.teorico.ent.5neu.decay <- sum( diag( table( pacientes.prediccion.5neu.decay.class, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  # TEST
  
  pacientes.prediccion.test.decay.5neu <- predict( pacientes.5neu.decay, matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], type="raw" )
  pacientes.prediccion.test.decay.5neu
  
  pacientes.prediccion.test.decay.5neu.class <- apply( pacientes.prediccion.test.decay.5neu, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.decay.5neu.class
  
  conf.5neu.d[[i]] <- table( pacientes.prediccion.test.decay.5neu.class , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.teorico.test.5neu.decay <- sum( diag( table( pacientes.prediccion.test.decay.5neu.class, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_5Neu_decay = acierto.teorico.ent.5neu.decay,
                                 Test_5neu_decay = acierto.teorico.test.5neu.decay)
  
  dataframe.resultados.5neu.decay <- rbind(dataframe.resultados.5neu.decay, dataframe.pasada)
  
}

head(dataframe.resultados.5neu.decay[order(dataframe.resultados.5neu.decay$Test_5neu_decay, decreasing = T), ])

# El mejor entrenamiento ha sido en la pasada # 3

conf.5neu.d[[3]]

```


###################### CON SOFTMAX ##############################

```{r 5_neuronas_decay_SOFTMAX}

set.seed(1)

dataframe.resultados.5neu.decay.softmax <- data.frame(Ent_5Neu_decay_sf = numeric(),
                                                      Test_5Neu_decay_sf = numeric())

conf.5neu.d.s <- vector(mode = "list", length = 50)

for(i in 1:50)
{


  pacientes.5neu.decay.softmax <- nnet( matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24],
                                        class.ind( matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ,
                                        size=5,
                                        softmax = T, 
                                        decay = 0.05,
                                        trace = F)
  
  pacientes.prediccion.5neu.decay.softmax <- predict( pacientes.5neu.decay.softmax, matriz.pacientes.datos.centscal[conjuntoEntrenamiento, 1:24], type="raw" )
  head(pacientes.prediccion.5neu.decay.softmax) # Vemos las probabilidades de pertenencia de cada valor
  
  pacientes.prediccion.5neu.decay.class.softmax <- apply( pacientes.prediccion.5neu.decay.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.5neu.decay.class.softmax
  
  table( pacientes.prediccion.5neu.decay.class.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] )  # Lo vemos en forma de tabla.
  
  acierto.teorico.ent.5neu.decay.sf <- sum( diag( table( pacientes.prediccion.5neu.decay.class.softmax, matriz.pacientes.etiquetas[conjuntoEntrenamiento, 25] ) ) )/55 # Esta cuenta nos da el índice de acierto
  
  # TEST
  
  pacientes.prediccion.test.decay.5neu.softmax <- predict( pacientes.5neu.decay.softmax, matriz.pacientes.datos.centscal[-conjuntoEntrenamiento, 1:24], type="raw" )
  pacientes.prediccion.test.decay.5neu.softmax
  
  pacientes.prediccion.test.decay.5neu.class.softmax <- apply( pacientes.prediccion.test.decay.5neu.softmax, MARGIN=1, FUN='which.is.max')
  pacientes.prediccion.test.decay.5neu.class.softmax
  
  conf.5neu.d.s[[i]] <- table( pacientes.prediccion.test.decay.5neu.class.softmax , matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] )
  acierto.teorico.test.5neu.decay.sf <- sum( diag( table( pacientes.prediccion.test.decay.5neu.class.softmax, matriz.pacientes.etiquetas[-conjuntoEntrenamiento, 25] ) ) )/12
  
  
  dataframe.pasada <- data.frame(Ent_5Neu_decay_sf = acierto.teorico.ent.5neu.decay.sf,
                                 Test_5neu_decay_sf = acierto.teorico.test.5neu.decay.sf)
  
  dataframe.resultados.5neu.decay.softmax <- rbind(dataframe.resultados.5neu.decay.softmax, dataframe.pasada)
  
}

head(dataframe.resultados.5neu.decay.softmax[order(dataframe.resultados.5neu.decay.softmax$Test_5neu_decay_sf, decreasing = T), ])

# El mejor entrenamiento ha sido en la pasada 12, 25, 27

conf.5neu.d.s[[12]]
conf.5neu.d.s[[25]]
conf.5neu.d.s[[27]]

```


Ahora lo que hay que hacer es unir todos los resultados:

```{r join_resultados_perceptron}

dataframe.resultados.perceptron <- cbind(dataframe.resultados.1neu,
                                         dataframe.resultados.1neu.soft,
                                         dataframe.resultados.2neu,
                                         dataframe.resultados.2neu.soft,
                                         dataframe.resultados.3neu,
                                         dataframe.resultados.3neu.soft,
                                         dataframe.resultados.3neu.decay,
                                         dataframe.resultados.3neu.decay.softmax,
                                         dataframe.resultados.5neu,
                                         dataframe.resultados.5neu.soft,
                                         dataframe.resultados.5neu.decay,
                                         dataframe.resultados.5neu.decay.softmax)

remove(dataframe.resultados.1neu)
remove(dataframe.resultados.1neu.soft)
remove(dataframe.resultados.2neu)
remove(dataframe.resultados.2neu.soft)
remove(dataframe.resultados.3neu)
remove(dataframe.resultados.3neu.soft)
remove(dataframe.resultados.3neu.decay)
remove(dataframe.resultados.3neu.decay.softmax)
remove(dataframe.resultados.5neu)
remove(dataframe.resultados.5neu.soft)
remove(dataframe.resultados.5neu.decay)
remove(dataframe.resultados.5neu.decay.softmax)

```

Ahora visualizamos los mejores resultados de cada entrenamiento:

```{r analisis_resultados_perceptron}

# Obtenemos los máximos de cada columna de test y guardamos:

max.1neu <- max(dataframe.resultados.perceptron[, 2])
max.1neu.s <- max(dataframe.resultados.perceptron[, 4])
max.2neu <- max(dataframe.resultados.perceptron[, 6])
max.2neu.s <- max(dataframe.resultados.perceptron[, 8])
max.3neu <- max(dataframe.resultados.perceptron[, 10])
max.3neu.s <- max(dataframe.resultados.perceptron[, 12])
max.3neu.d <- max(dataframe.resultados.perceptron[, 14])
max.3neu.d.s <- max(dataframe.resultados.perceptron[, 16])
max.5neu <- max(dataframe.resultados.perceptron[, 18])
max.5neu.s <- max(dataframe.resultados.perceptron[, 20])
max.5neu.d <- max(dataframe.resultados.perceptron[, 22])
max.5neu.d.s <- max(dataframe.resultados.perceptron[, 24])

array.maximos.perceptron <- c(max.1neu, 
                              max.1neu.s, 
                              max.2neu,
                              max.2neu.s,
                              max.3neu,
                              max.3neu.s,
                              max.3neu.d, 
                              max.3neu.d.s, 
                              max.5neu, 
                              max.5neu.s, 
                              max.5neu.d, 
                              max.5neu.d.s)

barplot(array.maximos.perceptron,
        main = "Mejores Resultados en Test con Perceptrones",
        xlab = "Tipo de Perceptrón",
        ylab = "Acierto (Tanto por 1)",
        names.arg = c("1 Neu", "1 Neu Soft", 
                      "2 Neu", "2 Neu Soft", 
                      "3 Neu", "3 Neu Soft", "3 Neu Decay", "3 Neu Soft Decay", 
                      "5 Neu", "5 Neu Soft", "5 Neu Decay", "5 Neu Soft Decay")
      )

```

Exporto a PDF este barplot:

```{r export_PDF_barplot_perceptrones}

pdf("Imágenes Obtenidas/BarplotResultadosPerceptron.pdf")

barplot(array.maximos.perceptron,
        main = "Mejores Resultados en Test con Perceptrones",
        xlab = "Tipo de Perceptrón",
        ylab = "Acierto (Tanto por 1)",
        names.arg = c("1 Neu", "1 Neu Soft", 
                      "2 Neu", "2 Neu Soft", 
                      "3 Neu", "3 Neu Soft", "3 Neu Decay", "3 Neu Soft Decay", 
                      "5 Neu", "5 Neu Soft", "5 Neu Decay", "5 Neu Soft Decay")
      )

dev.off

```


# Obtención de Resultados de Perceptrón

Importo los datos:

```{r importacion_datos_resultados_finales}

dataset.resultados <- read.csv2("Datos/Resultados.txt")

```

Ahora voy a sacar un gráfico interactivo donde comparo los resultados.


```{r grafico_resultados_interactivo}

tipos = dataset.resultados[, 1]
real = dataset.resultados[, 2]
practico = dataset.resultados[, 3]

p <- plot_ly(dataset.resultados, x = ~tipos, y = ~real, type = 'bar', name = 'Real') %>% add_trace(y = ~practico, name = 'Práctico') %>% layout(yaxis = list(title = 'Porcentaje'), barmode = 'group')

p 
#Mostramos el gráfico interactivo

```








Dendrograma:

```{r dendrograma}

matriz.dendrograma = lapply(matriz.pacientes.datos, as.numeric)
dendrograma = hclust(dist(as.matrix(unlist(matriz.dendrograma))) )

plot(dendrograma)

```


